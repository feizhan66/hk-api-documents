## POS机客户端接入

### 场景解释
开发一个客户端程序，来实现门店账号对订单的实时线下收款、退款、查询订单等操作；  
一般是安卓系统的POS机、或是Windows系统的收银台电脑。

POS机线下常用的收款场景：
1. 刷卡支付（客户被扫）：商家在终端输入收款金额，然后扫描消费者提供的`付款码(auth_code)`来实现即时支付。
2. 扫码支付（客户主扫）：商家在终端输入收款金额，生成临时`收款二维码(code_url)`向消费者展示，消费者主动扫码付款。

### 客户端主要功能模块

1. 门店用户登录 [登录接口](/user-login.md)
2. 输入金额收款(可以选择收款方式：主扫、被扫) [统一下单接口](/wechat/order-create.md) | [刷卡支付接口](/wechat/payment-micropay.md)
(若无法马上获取订单支付状态时，请按时间间隔`轮询`查询订单状态 [订单查询](/wechat/order-query.md))
4. 付款订单列表(收银员可以按照日期和状态来筛选) [订单列表接口](/wechat/order-list.md) 
6. 退款订单列表(收银员可以按照日期和状态来筛选) [退款列表接口](/wechat/refund-list.md)
7. 订单详情页面(展示订单信息如支付时间、金额等)[订单查询接口](/wechat/order-query.md)
8. 退款详情页面(展示退款信息如支付时间、金额等)[退款查询接口](/wechat/payment-refundquery.md)
9. 退款操作(付款订单列表处操作退款) [退款接口](/wechat/payment-refund.md) 
10. 系统设置(设置服务器、打印机、语言等)

`注意：以上接口有门店id(store_id)参数时,则传登陆时获取的门店id(store_id)`

### 主要操作流程

#### 登录流程
[接口详细解释](/user-login.md)
1. 客户端收集账号密码登录；
2. 请求接口，获取登录态并缓存。   
`登录后可以获取信息：商户名称、门店名称、store_id和接口密钥等信息`

#### 刷卡支付(客户被扫)
[接口详细解释](/wechat/payment-micropay.md)
1. 门店收银员在客户端输入收款金额，选择刷卡支付，调用输入设备(POS机相机、扫码抢)；
2. 消费者向门店收银员展示付款码；
3. 收银员使用设备(POS机相机、扫码抢)扫描消费者提供的付款码；
4. 客户端读取条形码或二维码，并解析为一段数字的`付款码(auth_code)`；
5. 以`付款码(auth_code)`来请求刷卡支付接口；
6. 如果即时支付成功，则提示收款成功；    
如果接口返回等待信息，请间隔(2~5秒)轮询[订单查询接口](/wechat/order-query.md),直至提示订单成功，并设置轮询超时(建议30秒)。    
`提示：订单支付中(轮询期间)，收银员可以强制停止轮询`    
`提示：门店收银员也可以前往[待支付订单列表]手动查询订单状态`

#### 扫码支付(客户主扫)
[接口详细解释](/wechat/order-create.md)
1. 门店收银员在客户端输入收款金额，选择扫码支付，调用接口生成临时二维码；
2. 门店收银员向消费者展示收款二维码；
3. 消费者扫码并支付；
4. 请间隔(2~5秒)轮询[订单查询接口](/wechat/order-query.md),直至提示订单成功，并设置轮询超时(建议60秒)。    
`提示：订单支付中(轮询期间)，收银员可以强制停止轮询`    
`提示：门店收银员也可以前往[待支付订单列表]手动查询订单状态`

#### 退款操作
[接口详细解释](/wechat/payment-refund.md)
1. 门店收银员前往订单列表，打开订单详情，操作退款；
2. 输入退款描述，请求退款接口； 
3. 如果即时退款成功，则提示退款成功；     
   如果接口返回等待信息，则提示需要1-7个工作日退款。    
   [退款查询接口](/wechat/payment-refundquery.md)     
   `提示：门店收银员也可以前往[退款订单列表]手动查询退单状态`



